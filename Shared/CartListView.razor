@using FakeProduct.Models
@using FakeProduct.Services
@inject LocalStorageDataService localStorageService
@inject FakeStoreCartsService fakeStoreService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider authenticationStateProvider

<tr>
    <td>
        <text>@cart.Id</text>&ensp;
        @if(idUser.HasValue && cart.UserId == idUser.Value)
        {
            <span class="badge bg-success">Meu</span>
        }
    </td>
    @if (cart.Products.Count == 0) {
        <td>Sem</td>
    }
    else {
        <td>@cart.Products.Count</td>
    }
    <td>@cart.Products.Sum(p => p.Quantity)</td>
    <td>@Total.ToString("C")</td>
    <td class="text-nowrap">
        <button class="btn btn-primary btn-sm" @onclick="DoVer">Ver</button>
        <button class="btn btn-danger btn-sm" @onclick="DoRemover">Remover</button>
    </td>
</tr>

@code {
    [Parameter]
    public Cart cart { get; set; } = new();

    [Parameter]
    public Action? OnRemover { get; set; }

    private int? idUser = null;
    private decimal Total = 0;

    protected override async Task OnParametersSetAsync()
    {
        if (cart == null)
        {
            Total = 0;
        }
        else
        {
            var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
            idUser = authState.GetUserId();

            Total = cart.Products.Sum(p =>
            {
                var product = localStorageService.Produtos.FirstOrDefault(w => w.Id == p.ProductId);
                return product != null ? product.Price * p.Quantity : 0;
            });
        }
    }

    private async void DoRemover()
    {
        if (cart.Id <= 0)
            return;

        if (await fakeStoreService.DeleteCartAsync(cart.Id))
            OnRemover?.Invoke();
    }

    private void DoVer()
    {
        navigationManager.NavigateTo($"/carrinho/{cart.Id}", false);
    }
}
